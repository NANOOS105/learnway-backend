# .github/workflows/deploy.yml
name: Deploy to AWS

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]


env:
  PROJECT_NAME: aselcni
  BUCKET_NAME: learnway-bucket
  CODE_DEPLOY_APP_NAME: learnway
  DEPLOYMENT_GROUP_NAME: learnway
  EC2_USER: ubuntu
  EC2_HOST: ${{ secrets.EC2_INSTANCE_IP }}
  PROJECT_DIR: /home/ubuntu/aselcni
  
jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v2

      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.5.3
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      - name: Create project directory on EC2
        run: |
          ssh -o StrictHostKeyChecking=no ${{ env.EC2_USER }}@${{ env.EC2_HOST }} "mkdir -p ${{ env.PROJECT_DIR }}"


      - name: Copy files to EC2
        run: |
          scp -o StrictHostKeyChecking=no -r * ${{ env.EC2_USER }}@${{ env.EC2_HOST }}:${{ env.PROJECT_DIR }}

      - name: Run build and deploy on EC2
        run: |
          ssh -o StrictHostKeyChecking=no ${{ env.EC2_USER }}@${{ env.EC2_HOST }} << 'EOF'
          cd ${{ env.PROJECT_DIR }}
          chmod +x ./gradlew
          ./gradlew build --warning-mode all --scan
          aws deploy create-deployment --application-name $CODE_DEPLOY_APP_NAME --deployment-config-name CodeDeployDefault.OneAtATime --deployment-group-name $DEPLOYMENT_GROUP_NAME --s3-location bucket=$BUCKET_NAME,bundleType=zip,key=$PROJECT_NAME/$GITHUB_SHA.zip
          EOF
