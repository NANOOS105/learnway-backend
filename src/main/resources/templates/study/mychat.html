<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
<meta charset="UTF-8">
<title>채팅방</title>
<script src="https://code.jquery.com/jquery-3.4.1.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.5.1/sockjs.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script><!-- jquery 는 항상 위에둘것 -->
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js"></script><!-- 부트스트랩 js -->
    <link rel="stylesheet" href="/css/study/studyList.css" type="text/css"/>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css"><!-- 부트스트랩 css -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css"> <!-- 이모티콘 -->
    <link rel="stylesheet" type="text/css" href="/css/consult/sidebarConsultantList.css"><!-- 상담예약 css파일 -->
    <link rel="stylesheet" type="text/css" href="/css/consult/sidebarReservationList.css"><!-- 예약리스트 css파일 -->

<style>
body {
    display: flex;
    height: 100vh;
    margin: 0;
    font-family: 'Noto Sans KR', sans-serif;
    background-color: #f0f2f5;
}

#main-content {
    flex: 1;
    display: flex;
}

#chat-container {
    flex: 1;
    display: flex;
    flex-direction: column;
    background-color: white;
    box-shadow: 0 0 10px rgba(0,0,0,0.1);
}

#chat-header {
    padding: 15px;
    background-color: #4a76a8;
    color: white;
    font-weight: bold;
    text-align: center;
}

#msgArea {
    display: flex;
    flex-direction: column;
    flex: 1;
    overflow-y: auto;
    padding: 20px;
}

#input-area {
    display: flex;
    padding: 15px;
    background-color: #f0f2f5;
}

#msg {
    flex: 1;
    padding: 10px;
    border: none;
    border-radius: 20px;
    margin-right: 10px;
}

#button-send {
    background-color: #4a76a8;
    color: white;
    border: none;
    border-radius: 50%;
    width: 40px;
    height: 40px;
    cursor: pointer;
    transition: background-color 0.3s;
}

#button-send:hover {
    background-color: #3a5a78;
}

.message {
    display: flex;
    margin: 10px 0;
    max-width: 70%;
}

.message.self {
    align-self: flex-end;
    justify-content: flex-end;
}

.message.other {
    align-self: flex-start;
    justify-content: flex-start;
}

.bubble {
    padding: 10px 15px;
    border-radius: 18px;
    word-wrap: break-word;
    max-width: 100%;
    box-shadow: 0 1px 2px rgba(0,0,0,0.1);
}

.self .bubble {
    background-color: #4a76a8;
    color: white;
}

.other .bubble {
    background-color: #e9eaeb;
    color: black;
    border: 1px solid #e0e0e0;
}

.name {
    font-weight: bold;
    margin-bottom: 5px;
    font-size: 0.9em;
}

.content {
    margin-bottom: 5px;
}

.time {
    font-size: 0.75em;
    color: #888;
    text-align: right;
}

#participants {
    width: 250px;
    padding: 20px;
    background-color: white;
    box-shadow: -5px 0 10px rgba(0,0,0,0.1);
}

#participants h3 {
    margin-top: 0;
    color: #4a76a8;
}

.participant-group {
    margin-bottom: 20px;
}

.participant-group h4 {
    color: #4a76a8;
    border-bottom: 1px solid #e0e0e0;
    padding-bottom: 5px;
}

#participants ul {
    list-style-type: none;
    padding: 0;
}

#participants li {
    margin-bottom: 10px;
    display: flex;
    align-items: center;
}

.crown-icon {
    margin-right: 5px;
}

</style>


<script>
    function getFormattedTime() {
        var now = new Date();

        var hours = now.getHours();
        var minutes = now.getMinutes();
        var seconds = now.getSeconds();

        var period = hours >= 12 ? '오후' : '오전';
        hours = hours % 12;
        hours = hours ? hours : 12; // 0시를 12시로 변경

        // 두 자리 숫자로 포맷
        minutes = minutes < 10 ? '0' + minutes : minutes;

        var formattedTime = period + ' ' + hours + ':' + minutes;
        return formattedTime;
    }

    $(document).ready(function () {
        var roomId = $("#roomId").val();
        var name = $("#name").val();

        function getCurrentDateTime() {
            var now = new Date();
            var year = now.getFullYear();
            var month = ('0' + (now.getMonth() + 1)).slice(-2); // 월은 0부터 시작하므로 +1을 해준다. 두 자리로 표시하기 위해 slice를 사용
            var day = ('0' + now.getDate()).slice(-2); // 일자도 두 자리로 표시하기 위해 slice를 사용
            var hours = ('0' + now.getHours()).slice(-2); // 시간
            var minutes = ('0' + now.getMinutes()).slice(-2); // 분
            var seconds = ('0' + now.getSeconds()).slice(-2); // 초

            return year + '-' + month + '-' + day + ' ' + hours + ':' + minutes + ':' + seconds;
        }

        function addMessageToUI(content) {
            var str = '';
            if (content.type === 'ENTER') {
                str = "<div class='message enter'>";
                str += "<div class='bubble'>";
                str += "<b>" + content.message + "</b><br/>";
                str += "</div></div>";
            } else if (content.type === 'CHAT') {
                if (content.name === name) {
                    str = "<div class='message self'>";
                } else {
                    str = "<div class='message other'>";
                }
                str += "<div class='bubble'>";
                str += "<div class='name'>" + content.name + "</div>";
                str += "<div class='content'>" + content.message + "</div>";
                str += "<div class='time'>" + content.date + "</div>";
                str += "</div></div>";
            }
            $("#msgArea").append(str);
            $("#msgArea").scrollTop($("#msgArea")[0].scrollHeight);
        }

        // 이전 채팅 내역 불러오기
        $.getJSON("/chatroom/" + roomId + "/messages", function (data) {
            data.forEach(function (message) {
                var content = {
                    type: 'CHAT',
                    name: message.member.memberName,
                    message: message.msg,
                    date: message.datetime.replace("T", " ") // ISO 8601 형식에서 공백으로 변경
                };
                addMessageToUI(content);
            });
        });

        var sock = new SockJS("/stomp/chat");
        var stomp = Stomp.over(sock);

        stomp.connect({}, function (frame) {
            console.log("Connected: 연결 " + frame);
            var datetime = getCurrentDateTime();

            stomp.subscribe("/sub/chat/room/" + roomId, function (chat) {
                var content = JSON.parse(chat.body);
                addMessageToUI(content);
            });

            stomp.send('/pub/chat/enter', {}, JSON.stringify({ type: 'ENTER', roomId: roomId, name: name, date:datetime}));
        });

        function sendMessage() {
            var msg = $("#msg").val();
            var datetime = getCurrentDateTime();
            stomp.send('/pub/chat/message', {}, JSON.stringify({ type: 'CHAT', roomId: roomId, message: msg, name: name, date: datetime }));
            $("#msg").val('');
        }

        $("#button-send").on("click", function () {
            sendMessage();
        });

        $("#msg").on("keypress", function (e) {
            if (e.which == 13) { // Enter key pressed
                sendMessage();
                return false; // Prevent the default action (form submission)
            }
        });
    });
</script>
</head>
<body>
<div th:replace="sidebar :: sidebar"></div>
<div id="main-content">
    <div id="chat-container">
        <div id="chat-header">
            <span id="roomname" th:text="${roomName}"></span>
        </div>
        <div id="msgArea"></div>
        <div id="input-area">
            <input type="text" id="msg" placeholder="메시지 입력">
            <button id="button-send"><i class="fas fa-paper-plane"></i></button>
        </div>
    </div>
    <div id="participants">
        <div class="participant-group">
            <h4>방장</h4>
            <ul>
                <li th:each="host : ${chatListHost}">
                    <span class="crown-icon">👑</span>
                    <span th:text="${host.member.memberName}"></span>
                </li>
            </ul>
        </div>
        <div class="participant-group">
            <h4>참여자</h4>
            <ul>
                <li th:each="guest : ${chatListGuest}" th:text="${guest.member.memberName}"></li>
            </ul>
        </div>
    </div>
</div>
<input type="hidden" id="roomId" th:value="${roomId}">
<input type="hidden" id="name" th:value="${name}">
</body>
 <script src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.5.1/sockjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js"></script>
    <script src="/js/consult/consultationReservation.js"></script>
    <script src="/js/consult/reservationList.js"></script>
</html>