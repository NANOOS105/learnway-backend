<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
<meta charset="UTF-8">
<title>채팅방</title>
<script src="https://code.jquery.com/jquery-3.4.1.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.5.1/sockjs.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>

<style>
    #msgArea {
        display: flex;
        flex-direction: column;
    }

    .message {
        display: flex;
        margin: 10px 0;
    }

    .message.self {
        justify-content: flex-start;
    }

    .message.other {
        justify-content: flex-end;
    }

    .bubble {
        max-width: 60%;
        padding: 10px;
        border-radius: 10px;
        word-wrap: break-word;
    }

    .self .bubble {
        background-color: #d1e7dd;
        color: #0f5132;
        align-self: flex-start;
    }

    .other .bubble {
        background-color: #f8d7da;
        color: #842029;
        align-self: flex-end;
    }
</style>

<script>

    function getFormattedTime() {
        var now = new Date();

        var hours = now.getHours();
        var minutes = now.getMinutes();
        var seconds = now.getSeconds();

        var period = hours >= 12 ? '오후' : '오전';
        hours = hours % 12;
        hours = hours ? hours : 12; // 0시를 12시로 변경

        // 두 자리 숫자로 포맷
        minutes = minutes < 10 ? '0' + minutes : minutes;
       

        var formattedTime = period + ' ' + hours + ':' + minutes;
        return formattedTime;
    }
    
    $(document).ready(function () {
        var roomId = $("#roomId").text();
        var name = $("#name").text();

        function getCurrentDateTime() {
            var now = new Date();
            var year = now.getFullYear();
            var month = ('0' + (now.getMonth() + 1)).slice(-2); // 월은 0부터 시작하므로 +1을 해준다. 두 자리로 표시하기 위해 slice를 사용
            var day = ('0' + now.getDate()).slice(-2); // 일자도 두 자리로 표시하기 위해 slice를 사용
            var hours = ('0' + now.getHours()).slice(-2); // 시간
            var minutes = ('0' + now.getMinutes()).slice(-2); // 분
            var seconds = ('0' + now.getSeconds()).slice(-2); // 초

            return year + '-' + month + '-' + day + ' ' + hours + ':' + minutes + ':' + seconds;
        }

        var sock = new SockJS("/stomp/chat");
        var stomp = Stomp.over(sock);

        stomp.connect({}, function (frame) {
            console.log("Connected: 연결 " + frame);

            stomp.subscribe("/sub/chat/room/" + roomId, function (chat) {
                var content = JSON.parse(chat.body);
                var str = '';

                if (content.type === 'ENTER') {
                    str = "<div class='message enter'>";
                    str += "<div class='bubble'>";
                    str += "<b>" + content.message + "</b><br/>";
                    str += "</div></div>";
                } else if (content.type === 'CHAT') {
                    if (content.name === name) {
                        str = "<div class='message self'>";
                        str += "<div class='bubble'>";
                        str += "<b>" + content.name + " : " + content.message + "</b><br/>";
                        str += content.date;
                        str += "</div></div>";
                    } else {
                        str = "<div class='message other'>";
                        str += "<div class='bubble'>";
                        str += "<b>" + content.name + " : " + content.message + "</b><br/>";
                        str += content.date;
                        str += "</div></div>";
                    }
                }
                $("#msgArea").append(str);
            });

            stomp.send('/pub/chat/enter', {}, JSON.stringify({ type: 'ENTER', roomId: roomId, name: name }));
        });

        function sendMessage() {
            var msg = $("#msg").val();
            var datetime = getCurrentDateTime();
            stomp.send('/pub/chat/message', {}, JSON.stringify({ type: 'CHAT', roomId: roomId, message: msg, name: name, date: datetime }));
            $("#msg").val('');
        }

        $("#button-send").on("click", function () {
            sendMessage();
        });

        $("#msg").on("keypress", function (e) {
            if (e.which == 13) { // Enter key pressed
                sendMessage();
                return false; // Prevent the default action (form submission)
            }
        });
    });
</script>
</head>
<body>
방번호 <span id="roomId" th:text="${roomId}"></span>
참여자 <span id="name" th:text="${name}"></span>
<div id="participants">
    <h3>참여자</h3>
    <table>
        <thead>
            <tr>
                <th>이름</th>
            </tr>
        </thead>
        <tbody>
            <tr th:each="host : ${chatListHost}">
                <td th:text="|방장 : ${host.member.memberName}|"></td>
            </tr>
            <tr th:each="guest : ${chatListGuest}">
                <td th:text="|참여자 : ${guest.member.memberName}|"></td>
            </tr>
        </tbody>
    </table>
</div>
<div th:if="${chatListHost!=null}">
    <p>채팅방장 값 넘어옴</p>
</div>
<div th:if="${chatListGuest!=null}">
    <p>채팅멤버값 넘어옴</p>
</div>

<div id="chatMessages">
        <h2>이전 채팅 내역</h2>
        <table>
            <thead>
                <tr>
                    <th>작성자</th>
                    <th>메시지</th>
                    <th>작성 시간</th>
                </tr>
            </thead>
            <tbody>
                <tr th:each="chatMessage : ${chatMessageList}">
                 <td th:text="${chatMessage.member.memberName}"></td>
                    <td th:text="${chatMessage.msg}"></td> 
                    <td th:text="${#temporals.format(chatMessage.datetime, 'yyyy-MM-dd HH:mm:ss')}"></td>
                </tr>
            </tbody>
        </table>
    </div>
    
<div id="msgArea"></div>
<input type="text" id="msg" placeholder="메시지 입력">
<button id="button-send">전송</button>
</body>
</html>